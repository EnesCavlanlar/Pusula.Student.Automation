@page "/admin/teachers"
@using Pusula.Student.Automation.Permissions
@attribute [Authorize(AutomationPermissions.Teachers.Default)]

@using Microsoft.AspNetCore.Authorization
@using Volo.Abp.Authorization            @* IsGrantedAsync extension *@
@using Pusula.Student.Automation.Teachers
@using Volo.Abp.Application.Dtos
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@inject ITeacherAppService TeachersApp
@inject IAuthorizationService AuthorizationService

<h3 class="mb-3">Teachers</h3>

<div class="d-flex gap-2 align-items-center mb-3">
    @if (_canCreate)
    {
        <button class="btn btn-primary" @onclick="ShowCreate">+ New Teacher</button>
    }

    <input class="form-control" style="max-width: 260px"
           placeholder="Search by name or email..."
           @bind="_search" @bind:event="oninput" />
    <button class="btn btn-outline-secondary" @onclick="LoadAsync">Search</button>
</div>

@if (_loading)
{
    <p>Loading...</p>
}
else if (_items.Count == 0)
{
    <div class="alert alert-info">No teachers found.</div>
}
else
{
    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th style="width: 220px;">
                    <button class="btn btn-link p-0" @onclick="() => SortBy(nameof(TeacherDto.FirstName))">
                        First Name @SortGlyph(nameof(TeacherDto.FirstName))
                    </button>
                </th>
                <th style="width: 220px;">
                    <button class="btn btn-link p-0" @onclick="() => SortBy(nameof(TeacherDto.LastName))">
                        Last Name @SortGlyph(nameof(TeacherDto.LastName))
                    </button>
                </th>
                <th style="width: 320px;">
                    <button class="btn btn-link p-0" @onclick="() => SortBy(nameof(TeacherDto.Email))">
                        Email @SortGlyph(nameof(TeacherDto.Email))
                    </button>
                </th>
                <th>Department</th>
                <th style="width: 160px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var t in _items)
            {
                <tr>
                    <td>@t.FirstName</td>
                    <td>@t.LastName</td>
                    <td>@t.Email</td>
                    <td>@t.Department</td>
                    <td class="text-nowrap">
                        @if (_canEdit)
                        {
                            <button class="btn btn-sm btn-secondary me-2" @onclick="() => Edit(t)">Edit</button>
                        }
                        @if (_canDelete)
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => ConfirmDelete(t.Id)">Delete</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center">
        <div>Total: @_totalCount</div>
        <div class="btn-group">
            <button class="btn btn-outline-secondary"
                    disabled="@(_pageIndex == 0)"
                    @onclick="PrevPage">
                Prev
            </button>

            <button class="btn btn-outline-secondary"
                    disabled="@(((long)_pageIndex + 1L) * _pageSize >= _totalCount)"
                    @onclick="NextPage">
                Next
            </button>
        </div>
    </div>
}

@if (_showModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,.5);" @onclick="CloseModal">
        <div class="modal-dialog" @onclick:stopPropagation>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(_editId is null ? "Create Teacher" : "Edit Teacher")</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseModal"></button>
                </div>

                <EditForm Model="_form" OnValidSubmit="SaveAsync">
                    <DataAnnotationsValidator />
                    <Microsoft.AspNetCore.Components.Forms.ValidationSummary />

                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">First Name</label>
                                <InputText class="form-control" @bind-Value="_form.FirstName" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Last Name</label>
                                <InputText class="form-control" @bind-Value="_form.LastName" />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Email</label>
                                <InputText class="form-control" @bind-Value="_form.Email" />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Department</label>
                                <InputText class="form-control" @bind-Value="_form.Department" />
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" @onclick="CloseModal" disabled="@_busy">Cancel</button>

                        @* Save: create için Create izni, edit için Edit izni şart *@
                        @if ((_editId is null && _canCreate) || (_editId is not null && _canEdit))
                        {
                            <button class="btn btn-primary" type="submit" disabled="@_busy">
                                @if (_busy)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Save
                            </button>
                        }
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@if (_showDeleteConfirm)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,.5);" @onclick="() => _showDeleteConfirm = false">
        <div class="modal-dialog modal-sm" @onclick:stopPropagation>
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="() => _showDeleteConfirm = false"></button>
                </div>
                <div class="modal-body">
                    Delete this teacher?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="() => _showDeleteConfirm = false">Cancel</button>

                    @if (_canDelete)
                    {
                        <button class="btn btn-danger" @onclick="DeleteAsync" disabled="@_busy">
                            @if (_busy)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Delete
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    // state
    private List<TeacherDto> _items = new();
    private long _totalCount;
    private bool _loading;
    private bool _busy;

    // permissions
    private bool _canCreate, _canEdit, _canDelete;

    // paging & sorting & search
    private int _pageIndex = 0;
    private int _pageSize = 10;
    private string? _sort = nameof(TeacherDto.FirstName);
    private bool _sortAsc = true;
    private string _search = string.Empty;

    // form modal
    private bool _showModal;
    private Guid? _editId;
    private CreateUpdateTeacherDto _form = new();

    // delete confirm
    private bool _showDeleteConfirm;
    private Guid _pendingDeleteId;

    protected override async Task OnInitializedAsync()
    {
        await CheckPermissionsAsync();
        await LoadAsync();
    }

    private async Task CheckPermissionsAsync()
    {
        _canCreate = await AuthorizationService.IsGrantedAsync(AutomationPermissions.Teachers.Create);
        _canEdit = await AuthorizationService.IsGrantedAsync(AutomationPermissions.Teachers.Edit);
        _canDelete = await AuthorizationService.IsGrantedAsync(AutomationPermissions.Teachers.Delete);
    }

    private async Task LoadAsync()
    {
        _loading = true;

        var input = new PagedAndSortedResultRequestDto
        {
            SkipCount = _pageIndex * _pageSize,
            MaxResultCount = _pageSize,
            Sorting = _sort is null ? null : $"{_sort} {(_sortAsc ? "ASC" : "DESC")}"
        };

        var list = await TeachersApp.GetListAsync(input);

        // client-side filter
        var items = list.Items.AsEnumerable();
        if (!string.IsNullOrWhiteSpace(_search))
        {
            var s = _search.Trim().ToLowerInvariant();
            items = items.Where(i =>
                (i.FirstName ?? "").ToLowerInvariant().Contains(s) ||
                (i.LastName ?? "").ToLowerInvariant().Contains(s) ||
                (i.Email ?? "").ToLowerInvariant().Contains(s));
        }

        // client-side sort
        if (!string.IsNullOrWhiteSpace(_sort))
        {
            Func<TeacherDto, object?> key = _sort switch
            {
                nameof(TeacherDto.FirstName) => i => i.FirstName,
                nameof(TeacherDto.LastName) => i => i.LastName,
                nameof(TeacherDto.Email) => i => i.Email,
                _ => i => i.FirstName
            };
            items = _sortAsc ? items.OrderBy(key) : items.OrderByDescending(key);
        }

        _items = items.ToList();
        _totalCount = list.TotalCount;
        _loading = false;
        StateHasChanged();
    }

    private void ShowCreate()
    {
        _editId = null;
        _form = new CreateUpdateTeacherDto();
        _showModal = true;
    }

    private void Edit(TeacherDto dto)
    {
        _editId = dto.Id;
        _form = new CreateUpdateTeacherDto
        {
            FirstName = dto.FirstName,
            LastName = dto.LastName,
            Email = dto.Email,
            Department = dto.Department
        };
        _showModal = true;
    }

    private async Task SaveAsync()
    {
        _busy = true;

        if (_editId is null)
            await TeachersApp.CreateAsync(_form);
        else
            await TeachersApp.UpdateAsync(_editId.Value, _form);

        _busy = false;
        _showModal = false;
        await LoadAsync();
    }

    private void CloseModal() => _showModal = false;

    private void SortBy(string field)
    {
        if (_sort == field) _sortAsc = !_sortAsc;
        else { _sort = field; _sortAsc = true; }
        _ = LoadAsync();
    }

    private MarkupString SortGlyph(string field)
    {
        if (_sort != field) return (MarkupString)string.Empty;
        var glyph = _sortAsc ? "▲" : "▼";
        return (MarkupString)$"<span class='ms-1'>{glyph}</span>";
    }

    private void PrevPage()
    {
        if (_pageIndex == 0) return;
        _pageIndex--;
        _ = LoadAsync();
    }

    private void NextPage()
    {
        if (((long)_pageIndex + 1L) * _pageSize >= _totalCount) return;
        _pageIndex++;
        _ = LoadAsync();
    }

    private void ConfirmDelete(Guid id)
    {
        _pendingDeleteId = id;
        _showDeleteConfirm = true;
    }

    private async Task DeleteAsync()
    {
        _busy = true;
        await TeachersApp.DeleteAsync(_pendingDeleteId);
        _busy = false;
        _showDeleteConfirm = false;
        await LoadAsync();
    }
}
